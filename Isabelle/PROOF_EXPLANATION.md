# Объяснение структурного доказательства в Coffee.thy

## Проблема с предыдущим подходом

Изначальное доказательство было "слишком прямолинейным" - оно использовало конкретные значения цен прямо в доказательстве:
- `coffee_price Arabica AlmondMilk = 73.58`
- `coffee_price Robusta WholeMilk = 47.25`
- и т.д.

**Проблема**: При изменении любой цены нужно было переписывать все доказательство.

## Новый структурный подход

### 1. Абстрактные функции максимумов

Вместо конкретных значений используем абстрактные функции:
```isabelle
fun max_beans_price :: real where
  "max_beans_price = Max {beans_price b | b. True}"

fun max_milk_price :: real where  
  "max_milk_price = Max {milk_price m | m. True}"

fun max_brewing_time :: nat where
  "max_brewing_time = Max {brewing_time b | b. True}"
```

### 2. Структурные леммы

Доказываем общие свойства без привязки к конкретным значениям:

**Лемма о базовой цене**:
```isabelle
lemma base_price_bounded:
  "∀b m. beans_price b + milk_price m ≤ max_beans_price + max_milk_price"
```

**Лемма о надбавке бариста**:
```isabelle
lemma barista_fee_percent_bounded:
  "∀b. barista_fee_percent b ≤ base_barista_fee + (real max_brewing_time / 1000)"
```

### 3. Основное доказательство без конкретных значений

Главная теорема использует только структурные свойства:

1. **Формула цены**: `coffee_price b m = base_price * (1 + fee_percent / 100)`
2. **Структурная граница**: `coffee_price b m ≤ (max_beans_price + max_milk_price) * (1 + max_fee_percent / 100)`
3. **Абстрактная проверка**: Верхняя граница ≤ max_price

### 4. Изоляция конкретных вычислений

Конкретные значения (45, 30, 15, 25, 120, 90, 5) используются **только** в двух местах:
1. В определениях функций `beans_price`, `milk_price`, `brewing_time`
2. В финальной численной проверке границы

**Основная логика доказательства полностью абстрактна!**

## Преимущества нового подхода

### ✅ Устойчивость к изменениям
- При изменении цены зерен: меняем только `beans_price.simps`
- При изменении цены молока: меняем только `milk_price.simps`  
- При изменении времени варки: меняем только `brewing_time.simps`
- При изменении базовой надбавки: меняем только `base_barista_fee_def`

**Основное доказательство остается неизменным!**

### ✅ Читаемость и понятность
- Четко видна структура: база + надбавка
- Понятны источники верхних границ
- Легко проследить логику рассуждений

### ✅ Расширяемость
- Легко добавить новые типы зерен/молока
- Просто изменить формулу надбавки
- Можно добавить новые ограничения

### ✅ Математическая строгость
- Доказательство основано на структурных свойствах
- Использует монотонность и ограниченность
- Конкретные значения изолированы от логики

## Ключевые структурные свойства

1. **Монотонность**: Более дорогие ингредиенты → более высокая цена
2. **Ограниченность**: Все компоненты имеют верхние границы  
3. **Композиционность**: Общая цена = функция от компонентов
4. **Безопасность**: Значительный запас до лимита (26+ единиц)

## Заключение

Новое доказательство решает проблему "хрупкости" - теперь при изменении бизнес-параметров нужно изменить только определения функций, а вся логика доказательства остается стабильной. Это делает формальную верификацию практически применимой для реальных бизнес-систем. 